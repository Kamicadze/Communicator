#include "CMessageHandler.h"
#include "SFrame.h"
#include <sstream>
#include <string.h>
#include <sys/socket.h>

CMessageHandler::CMessageHandler()
{}

CMessageHandler::~CMessageHandler()
{}

void CMessageHandler::sendToAll(CThPool *tp, SFrame frame)
{
    SFrame o_allFrame;
    for(auto it=tp->broad.begin(); it!=tp->broad.end(); ++it)
    {
        if(it->first!=frame.m_CID)
        {
        
            o_allFrame=frame;
            strcpy(o_allFrame.m_DCID, it->first.c_str());
            o_allFrame.m_dataType=3;
            o_allFrame.m_destenationPort=it->second;
            //TODO: add a possibility to add write to task queue
            write(it->second, &o_allFrame, sizeof(o_allFrame));

        }
        
    }
}

void CMessageHandler::broadcast(CThPool *tp, int port, std::string login)
{

    SFrame o_frame;
    tp->broad[login]=port;
    memset(&o_frame, 0, sizeof(o_frame));
    int dt=0;
    while(1)
    {
        recv(port, &o_frame, sizeof(o_frame), MSG_WAITALL);
        dt=static_cast<int>(o_frame.m_dataType);
        if(dt==3)
        {
            sendToAll(tp, o_frame);
        }
        else if(dt==5)
        {
            break;
        }
        else
        {
            //TODO:error handling
        }
        memset(&o_frame, 0, sizeof(o_frame));
    }
    tp->broad.erase(login); 

}

void CMessageHandler::createChatRoom(SFrame cliFrame, int cliSock, CThPool *tp)
{
    tp->chatRooms[cliFrame.m_CID]=cliSock;  
    std::istringstream ss;
    ss.str(cliFrame.m_messageData);
    std::string login, nUsers;
    SFrame invFrame;
    nUsers=cliFrame.m_messageData;

    while(ss>>login)
    {
            invFrame=cliFrame;
            strcpy(invFrame.m_DCID, login.c_str());
            invFrame.m_destenationPort=tp->online[login];
            sprintf(invFrame.m_messageData, "%s", nUsers.c_str());
            invFrame.m_dataType=6; ///6 is invite type for user and join chat for server
            write(invFrame.m_destenationPort, &invFrame, sizeof(invFrame));
    }

    chatRoomHandler(cliFrame.m_CID, cliSock, cliFrame.m_CID, tp, nUsers);
    


}

void CMessageHandler::chatRoomHandler(std::string login, int port, std::string host, CThPool *tp, std::string invs)
{
    
    
    
    
    SFrame o_frame;
    memset(&o_frame, 0, sizeof(o_frame));
    int dt=-1;
    std::string nLogin, buff;
    int nPort;

    std::map<std::string, int> chat;
    chat[login]=port;
    if(0!=login.compare(login))
    {
        chat[host]=tp->online[host];
    }
    while(invs >> nLogin)
    {
        if(nLogin!=login || nLogin!=host)
        {
            std::cout<<"nlogin: "<<nLogin<<std::endl;
            chat[nLogin]=tp->online[nLogin];
        }
    }

    while(1)
    {
        recv(port, &o_frame, sizeof(o_frame), MSG_WAITALL);
        dt=static_cast<int>(o_frame.m_dataType);

        if(2==dt)
        {
            std::string inviteLogin;
            inviteLogin=o_frame.m_messageData;
            int invitePort=tp->online[inviteLogin];
            SFrame inviteFrame;
            memset(&inviteFrame, 0, sizeof(inviteFrame));
            sprintf(inviteFrame.m_CID, "%s",  host.c_str());
            sprintf(inviteFrame.m_DCID, "%s", inviteLogin.c_str());
            inviteFrame.m_dataType=6;
            inviteFrame.m_sourcePort=port;
            inviteFrame.m_destenationPort=invitePort;
            sprintf(inviteFrame.m_messageData, "Invite");

            write(invitePort, &inviteFrame, sizeof(inviteFrame));

        }
        else if(4==dt)
        {
            writeToChat(chat, o_frame);
        }
        else if(5==dt)//EXIT
        {
            o_frame.m_dataType=11;
            strcpy(o_frame.m_CID, login.c_str());
            write(port, &o_frame, sizeof(o_frame));
            for(auto it=chat.begin(); it!=chat.end(); ++it)
            {
                if(it->first!=login)
                {
                    o_frame.m_destenationPort=it->second;
                    //TODO: add a possibility to add write to task queue
                    write(it->second, &o_frame, sizeof(o_frame));
                }
            }
            break;
        }

        else if(11==dt)//other user quit
        {
            chat.erase(o_frame.m_CID);
        }
        memset(&o_frame, 0, sizeof(o_frame));
    }

}
void CMessageHandler::writeToChat(std::map<std::string, int> chat, SFrame frame)
{

    SFrame chatFrame;
    for(auto it=chat.begin(); it!=chat.end(); ++it)
    {
        if(it->first!=frame.m_CID)
        {

            chatFrame=frame;
            strcpy(chatFrame.m_DCID, it->first.c_str());
            chatFrame.m_dataType=4;
            chatFrame.m_destenationPort=it->second;
            //TODO: add a possibility to add write to task queue
            write(it->second, &chatFrame, sizeof(chatFrame));

        }

    }


}
